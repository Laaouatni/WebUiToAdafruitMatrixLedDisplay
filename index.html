<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
</head>

<body class="p-4 grid gap-4">
  <main class="relative flex w-full aspect-[32/8] justify-between transition-all">
    <img src="./img/ipiaCesarePesenti.jpg">
    <div class="bg-red-500 h-full w-20"></div>
    <div class="bg-green-500 h-full w-20"></div>
    <div class="bg-blue-500 h-full w-20"></div>
    <div class="bg-yellow-500 h-full w-20"></div>
    <div class="bg-slate-500 h-full w-20"></div>
  </main>
</body>

<script>
  const esp32Ip = "192.168.194.3:80";
  convertUItoMatrixArrayOfColorsWithResolution(document.querySelector("main") || document.body).then(
    (pixelColorArray) => {
      fetch(`http://${esp32Ip}/updateDisplayPixels`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          dimensions: {
            width: pixelColorArray[0].length,
            height: pixelColorArray.length,
          },
          arrayColors: pixelColorArray,
        }),
      }).then((response) => {
        console.log(response);
      })
    }
  )

  function convertUItoMatrixArrayOfColorsWithResolution(
    paramHtmlElement,
    paramWidth = 32,
    paramHeight = 8,
  ) {
    return new Promise((res, rej) => {
      const clonedHtmlElement = paramHtmlElement.cloneNode(true);
      const styles = {
        height: `${paramHeight}px`,
        width: `${paramWidth}px`,
        position: "fixed",
        aspectRatio: "unset",
        get left() { return `-${this.width}` },
      }
      Object.entries(styles).forEach(([key, value]) => {
        clonedHtmlElement.style[key] = value;
      });
      document.body.appendChild(clonedHtmlElement);
      html2canvas(clonedHtmlElement).then((thisHtmlCanvas) => {
        const thisHtmlCtx = thisHtmlCanvas.getContext("2d");
        const thisUint8ClampedArray = thisHtmlCtx.getImageData(0, 0, thisHtmlCanvas.width, thisHtmlCanvas.height).data;
        let result = [];
        let positionOfObject = { x: 0, y: 0 };
        for (let forPixelIndex = 0; forPixelIndex < (paramWidth * paramHeight); forPixelIndex++) {
          const redIndex = forPixelIndex * 4;
          const pixelColorObject = {
            R: thisUint8ClampedArray[redIndex],
            G: thisUint8ClampedArray[redIndex + 1],
            B: thisUint8ClampedArray[redIndex + 2],
            A: thisUint8ClampedArray[redIndex + 3],
          };
          (() => {
            if (forPixelIndex == 0) {
              result[positionOfObject.y] = [];
              return;
            };
            if (forPixelIndex % paramWidth == 0) {
              positionOfObject.y++;
              result[positionOfObject.y] = [];
              positionOfObject.x = 0;
              return;
            }
            positionOfObject.x++;
          })();
          result[positionOfObject.y][positionOfObject.x] = pixelColorObject;
        }
        clonedHtmlElement.remove();
        res(result);
      });
    });
  };
</script>

</html>