<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
</head>

<body class="p-4 grid gap-4">
  <main class="relative w-full flex aspect-[32/8] justify-between transition-all">
    <div id="child" class="w-[20px] h-[50%] bg-red-500"></div>
    <!-- <video class="w-full object-cover" src="./img/INTRO VIDEO WITH COLOUR SMOKE EFFECT __ Tutorial video link & Templates dawnload link In Description.mp4" autoplay loop></video> -->
  </main>
</body>

<script>
  const esp32Ip = "192.168.194.3:80";

  sendImageToEsp32();

  const main = document.querySelector("main");

  main.addEventListener("mousemove", (e) => {
    const child = main.querySelector("#child");
    child.style.position = "fixed";
    child.style.left = `${e.pageX}px`;
    child.style.top = `${e.pageY}px`;
  });

  function sendImageToEsp32() {
    convertUItoMatrixArrayOfColorsWithResolution(document.querySelector("main") || document.body).then(
      (pixelColorArray) => {
        fetch(`http://${esp32Ip}/updateDisplayPixels`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            arrayColors: pixelColorArray,
          }),
        }).then((res) => {
          // sendImageToEsp32();
        });
      }
    )
  }
  
  function convertUItoMatrixArrayOfColorsWithResolution(
    paramHtmlElement,
    paramWidth = 32,
    paramHeight = 8,
  ) {
    return new Promise((res, rej) => {
      const clonedHtmlElement = paramHtmlElement.cloneNode(true);
      const styles = {
        height: `${paramHeight}px`,
        width: `${paramWidth}px`,
        position: "fixed",
        aspectRatio: "unset",
        get left() { return `-${this.width}` },
      }
      Object.entries(styles).forEach(([key, value]) => {
        clonedHtmlElement.style[key] = value;
      });
      document.body.appendChild(clonedHtmlElement);
      html2canvas(clonedHtmlElement).then((thisHtmlCanvas) => {
        const thisHtmlCtx = thisHtmlCanvas.getContext("2d");
        const thisUint8ClampedArray = thisHtmlCtx.getImageData(0, 0, thisHtmlCanvas.width, thisHtmlCanvas.height).data;
        let result = [];
        let positionOfObject = { x: 0, y: 0 };
        for (let forPixelIndex = 0; forPixelIndex < (paramWidth * paramHeight); forPixelIndex++) {
          const redIndex = forPixelIndex * 4;
          const pixelColorObject = {
            R: thisUint8ClampedArray[redIndex],
            G: thisUint8ClampedArray[redIndex + 1],
            B: thisUint8ClampedArray[redIndex + 2],
            A: thisUint8ClampedArray[redIndex + 3],
          };
          (() => {
            if (forPixelIndex == 0) {
              result[positionOfObject.y] = [];
              return;
            };
            if (forPixelIndex % paramWidth == 0) {
              positionOfObject.y++;
              result[positionOfObject.y] = [];
              positionOfObject.x = 0;
              return;
            }
            positionOfObject.x++;
          })();
          result[positionOfObject.y][positionOfObject.x] = [pixelColorObject.R, pixelColorObject.G, pixelColorObject.B];
        }
        clonedHtmlElement.remove();
        console.log(result);
        res(result);
      });
    });
  };
</script>

</html>