<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
  <script defer src="./script.js"></script>
</head>

<body class="p-4 grid gap-4">
  <main style="zoom:3;" class="relative flex w-[300px] h-[80px] justify-between bg-black">
    <img class="rotate-90 h-[450%] -translate-y-[100px]" src="./img/ronaldo.jpg">
    <!-- <div class="absolute w-[10px] h-[10px] bg-red-500 top-[20px] left-0"></div>
    <div class="absolute w-[10px] h-[10px] bg-red-500 top-[70px] left-0"></div>
    <div class="absolute w-[10px] h-[10px] bg-green-500 top-[70px] left-[290px]"></div>
    <div class="absolute w-[10px] h-[10px] bg-blue-500 top-[00px] left-[240px]"></div> -->
  </main>

  <div id="images" class="flex"></div>

  <button id="sendBtn" class="border border-green-500 bg-green-200 p-4 rounded shadow-lg shadow-green-500">click to
    send</button>
</body>

<script>
  const ipEsp32 = '192.168.162.49';
  const ws = new WebSocket(`ws://${ipEsp32}/ws`);

  document.getElementById("sendBtn").addEventListener("click", sendBtnClick);

  ws.addEventListener("close", () => {
    window.location.reload();
  });

  function sendBtnClick() {
    convertUItoMatrixArrayOfColorsWithResolution(
      document.querySelector("main") || document.body,
      32,
      8,
    );
  };

  const imgAverageColorPicker = new ColorThief();
  /**
   *
   * @param {HTMLElement} htmlElement
   * @param {number} x
   * @param {number} y
   * @param {never} options
 */
  function convertUItoMatrixArrayOfColorsWithResolution(
    htmlElement,
    x,
    y,
  ) {
    return new Promise((resolve, reject) => {
      html2canvas(htmlElement).then((thisHtmlCanvas) => {
        const thisHtmlCtx = thisHtmlCanvas.getContext("2d", { willReadFrequently: true });

        const canvasTotalWidth = thisHtmlCanvas.width;
        const canvasTotalHeight = thisHtmlCanvas.height;

        const canvasPartWidth = canvasTotalWidth / x;
        const canvasPartHeight = canvasTotalHeight / y;

        const result = [];

        for (let forX = 0; forX < x; forX++) {
          result[forX] = [];
          for (let forY = 0; forY < y; forY++) {
            const x0 = forX * canvasPartWidth;
            const y0 = forY * canvasPartHeight;

            const thisPartCanvas = document.createElement("canvas");
            thisPartCanvas.width = canvasPartWidth;
            thisPartCanvas.height = canvasPartHeight;
            const thisPartCtx = thisPartCanvas.getContext("2d");

            thisPartCtx.putImageData(
              thisHtmlCtx.getImageData(
                x0, y0,
                thisPartCanvas.width, thisPartCanvas.height
              ),
              0, 0
            );

            const thisPartImage = new Image(thisPartCanvas.width, thisPartCanvas.height);
            thisPartImage.src = thisPartCanvas.toDataURL();
            thisPartImage.width = thisPartCanvas.width;
            thisPartImage.height = thisPartCanvas.height;

            document.querySelector("#images").append(`${forX} ${forY} `);
            document.querySelector("#images").appendChild(thisPartImage);
            

            thisPartImage.addEventListener("load", () => {
              try {
                console.log(forX, forY, result)
                result[forX][forY] = imgAverageColorPicker.getColor(thisPartImage);
              } catch (err) { }
              if (forY == y - 1) {
                ws.send(JSON.stringify({ xLine: forX, colorArray: result[forX] }));
              };
              if (forY == y - 1 && forX == x - 1) resolve(result);
            })
          }
        }
      })
    })
  }
</script>

</html>