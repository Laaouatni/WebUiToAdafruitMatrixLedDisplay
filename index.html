<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
</head>

<body class="p-4 grid gap-4">
  <main class="outline relative w-full flex aspect-[32/8] justify-between transition-all">
    <div id="child" class="w-[80%] h-[50%] bg-red-500"></div>
    <!-- <video class="w-full object-cover" src="./img/INTRO VIDEO WITH COLOUR SMOKE EFFECT __ Tutorial video link & Templates dawnload link In Description.mp4" autoplay loop></video> -->
  </main>
</body>

<script>
  const esp32Ip = "192.168.194.3:80";

  sendImageToEsp32();

  function sendImageToEsp32() {
    convertUItoMatrixArrayOfColorsWithResolution(document.querySelector("main") || document.body).then(
      (pixelColorArray) => {
        fetch(`http://${esp32Ip}/updateDisplayPixels`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            arrayColors: pixelColorArray,
          }),
        }).then((res) => {
          // sendImageToEsp32();
        });
      }
    )
  }

  function convertUItoMatrixArrayOfColorsWithResolution(
    paramHtmlElement,
    paramWidth = 32,
    paramHeight = 8,
  ) {
    return new Promise((res, rej) => {
      const clonedHtmlElement = paramHtmlElement.cloneNode(true);
      const scale = paramWidth / paramHtmlElement.offsetWidth;
      clonedHtmlElement.style.width = `${paramWidth}px`;
      clonedHtmlElement.style.height = `${paramHeight}px`;
      scaleElementStyles(paramHtmlElement, clonedHtmlElement);
      document.body.appendChild(clonedHtmlElement);

      html2canvas(clonedHtmlElement).then((thisHtmlCanvas) => {
        const thisHtmlCtx = thisHtmlCanvas.getContext("2d");
        const thisUint8ClampedArray = thisHtmlCtx.getImageData(0, 0, thisHtmlCanvas.width, thisHtmlCanvas.height).data;
        let result = [];
        let positionOfObject = { x: 0, y: 0 };
        for (let forPixelIndex = 0; forPixelIndex < (paramWidth * paramHeight); forPixelIndex++) {
          const redIndex = forPixelIndex * 4;
          const pixelColorObject = {
            R: thisUint8ClampedArray[redIndex],
            G: thisUint8ClampedArray[redIndex + 1],
            B: thisUint8ClampedArray[redIndex + 2],
            A: thisUint8ClampedArray[redIndex + 3],
          };
          (() => {
            if (forPixelIndex == 0) {
              result[positionOfObject.y] = [];
              return;
            };
            if (forPixelIndex % paramWidth == 0) {
              positionOfObject.y++;
              result[positionOfObject.y] = [];
              positionOfObject.x = 0;
              return;
            }
            positionOfObject.x++;
          })();
          result[positionOfObject.y][positionOfObject.x] = [pixelColorObject.R, pixelColorObject.G, pixelColorObject.B];
        }
        clonedHtmlElement.remove();
        res(result);
      });

      function scaleElementStyles(originalElement, cloneElement) {
        const getComputedStyleOriginal = window.getComputedStyle(originalElement);

        const pxAttributes = [...getComputedStyleOriginal].filter((styleAttribute) => {
          return getComputedStyleOriginal[styleAttribute].includes("px");
        });

        pxAttributes.forEach((styleAttribute) => {
          const value = parseFloat(getComputedStyleOriginal[styleAttribute].replace("px", ""));
          const fixedTypo = styleAttribute.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
          cloneElement.style[fixedTypo] = `${value * scale}px`;
        });

        [...originalElement.children].forEach((_, i) => {
          scaleElementStyles(originalElement.children[i], cloneElement.children[i]);
        })
      };
    });
  };


</script>

</html>